<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reto Funcional 30 Días - Temporizador</title>
    
    <!-- 0. Favicon actualizado a un icono de ejercicio genérico -->
    <!-- Usamos un SVG codificado basado en el icono de ejercicio para el favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2c-4.4 0-8 3.6-8 8s3.6 8 8 8c.7 0 1.4-.1 2-.3M17 19l4-4M17 19l-4 4M21 15l-4 4M13 13L9 9M13 13l4-4'/%3E%3C/svg%3E">

    <!-- 1. Carga de Google Font 'Inter' para garantizar la tipografía en todos los modos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- 2. Carga de Material Symbols Outlined (para el splash screen) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=exercise" />

    <!-- Carga de Tailwind CSS para estilos Material Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones básicas y fuentes */
        :root {
            --color-primary: #10b981; /* Tailwind emerald-500 */
        }
        body {
            /* Fuente 'Inter' ahora es cargada y aplicada de manera consistente */
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Definición de colores de Material Card en modo claro */
        .card-bg {
            background-color: white;
            color: #374151; /* gray-700 */
        }
        .text-default {
            color: #1f2937; /* gray-800 */
        }

        /* ESTILOS CLAVE EN MODO OSCURO */
        .dark body {
            background-color: #1f2937; /* gray-800 */
        }
        /* Ajuste: Fondo de tarjeta más claro para contraste */
        .dark .card-bg {
            background-color: #374151; /* gray-700 (Un poco más claro que el body) */
            color: white; /* Texto blanco */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        /* Ajuste: Texto principal debe ser blanco/claro */
        .dark .text-default {
            color: #f3f4f6; /* gray-100 */
        }
        /* Ajuste: Separadores de lista */
        .dark .divide-gray-100 > li {
            border-color: #4b5563; /* gray-600 */
        }
        /* Ajuste: Hover en la lista para modo oscuro */
        .dark .hover\:bg-gray-100:hover {
            background-color: #4b5563;
        }
        /* Aseguramos que las etiquetas dentro de la lista sean legibles */
        .dark #routine-items label {
            color: #f3f4f6; /* gray-100 */
        }
        /* Ajuste para los textos secundarios dentro de la lista */
        .dark #routine-items .text-gray-400 {
             color: #9ca3af !important; /* gray-400, color claro sobre el fondo oscuro */
        }

        /* Clases dinámicas para el temporizador (mantienen colores fuertes) */
        .panel-work {
            background-color: #1d4ed8; /* Blue-700 */
            color: white;
            box-shadow: 0 15px 30px rgba(29, 78, 216, 0.4);
        }
        .panel-rest {
            background-color: #f59e0b; /* Amber-500 */
            color: white;
            box-shadow: 0 15px 30px rgba(245, 158, 11, 0.4);
        }
        .panel-done {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }

        /* Estilo personalizado para el indicador del checkbox */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #9ca3af; /* gray-400 */
            border-radius: 9999px;
            cursor: pointer;
            display: inline-grid;
            place-content: center;
            transition: all 0.2s;
        }
        input[type="checkbox"]::before {
            content: "";
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            transform: scale(0);
            transition: transform 0.2s ease-in-out;
            box-shadow: inset 1em 1em var(--color-primary);
        }
        input[type="checkbox"]:checked {
            border-color: var(--color-primary);
        }
        input[type="checkbox"]:checked::before {
            transform: scale(1);
        }
        /* Ajuste de color del checkbox en modo oscuro */
        .dark input[type="checkbox"] {
            border: 2px solid #6b7280; /* gray-500 */
        }

        /* Estilo para el modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .dark .modal-content {
            background-color: #374151; /* gray-700 */
            color: white;
        }

        /* --- ESTILO DE PANTALLA DE PRECARGA (SPLASH SCREEN) --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6; /* Fondo claro por defecto */
            z-index: 2000;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        .dark #splash-screen {
            background-color: #1f2937; /* Fondo oscuro */
        }
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-800 min-h-screen p-4 sm:p-8 overflow-x-hidden">

    <!-- PANTALLA DE PRECARGA (SPLASH SCREEN) -->
    <div id="splash-screen">
        <!-- Ícono de ejercicio de Material Symbols, grande y animado -->
        <span class="material-symbols-outlined text-emerald-500 text-7xl animate-bounce">
            exercise
        </span>
        <p class="mt-4 text-xl font-semibold text-gray-700 dark:text-gray-200">Cargando Reto 30 Días...</p>
    </div>

    <div class="max-w-4xl mx-auto w-full">
        <!-- Título principal y Botón de Tema -->
        <header class="text-center mb-8 flex justify-between items-center">
            <div class="w-1/6"></div> <!-- Espaciador izquierdo -->
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-default dark:text-gray-100">Reto Funcional 30 Días</h1>
                <p class="text-gray-500 dark:text-gray-400">Temporizador y Rutinas Semanales</p>
            </div>
            <div class="w-1/6 flex justify-end">
                 <!-- Botón de Modo Oscuro/Claro -->
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 transition-colors shadow-md hover:shadow-lg">
                    <!-- Icono SVG de un sol/luna (Light/Dark Mode) -->
                    <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Contenedor Flex: Temporizador (Arriba) y Rutina (Abajo) -->
        <main class="flex flex-col gap-8">
            
            <!-- PANEL DE CONTROL Y TEMPORIZADOR (Material Card) -->
            <section id="timer-panel" class="card-bg rounded-xl p-6 sm:p-8 shadow-xl text-center transition-all duration-500">
                <h2 id="current-activity" class="text-xl font-semibold h-10 flex items-center justify-center text-default dark:text-gray-200">Selecciona un día para comenzar</h2>
                <div id="countdown-display" class="text-7xl font-extrabold my-4 text-emerald-500">--:--</div>
                
                <div class="flex justify-center space-x-4">
                    <button id="start-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all transform hover:scale-105">
                        Iniciar Rutina
                    </button>
                    <button id="stop-btn" style="display:none;" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all transform hover:scale-105">
                        Pausa
                    </button>
                </div>
                
                <div id="status-bar" class="mt-4 text-sm text-gray-400 dark:text-gray-400">Día de la semana: Lunes (Fuerza)</div>
            </section>

            <!-- NAVEGACIÓN DE DÍAS (Tabs/Segmented Control) -->
            <nav id="day-tabs" class="flex flex-wrap justify-center gap-2 p-2 card-bg rounded-xl shadow-md">
                <!-- Los botones de día se inyectarán aquí con JavaScript -->
            </nav>
            
            <!-- LISTA DE EJERCICIOS (Material Card) -->
            <section id="workout-list" class="card-bg rounded-xl shadow-xl p-6 sm:p-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-default dark:text-gray-100 border-gray-200 dark:border-gray-600">Rutina: <span id="current-day-title">Lunes</span></h2>
                <ul id="routine-items" class="divide-y divide-gray-100 dark:divide-gray-600">
                    <!-- Los ejercicios se inyectarán aquí con JavaScript -->
                </ul>
                <p id="info-message" class="text-center text-sm text-gray-400 dark:text-gray-400 mt-4">La lista de ejercicios se actualizará al seleccionar un día.</p>
            </section>

        </main>
    </div>

    <!-- MODAL para mostrar las variaciones del ejercicio -->
    <div id="variation-modal" class="modal hidden">
        <div class="modal-content w-full sm:w-2/3 lg:w-1/2">
            <h3 class="text-2xl font-bold mb-4 text-default dark:text-white" id="modal-title">Variaciones del Ejercicio</h3>
            <div id="modal-content-text" class="text-gray-700 dark:text-gray-200 whitespace-pre-wrap">
                <!-- Contenido generado por la IA -->
            </div>
            <button id="close-modal-btn" class="mt-6 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 rounded-full transition-colors">Cerrar</button>
        </div>
    </div>

    <!-- Indicador de Carga -->
    <div id="loading-indicator" class="modal hidden">
        <div class="modal-content flex flex-col items-center p-8">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-default dark:text-white">Generando variaciones con Gemini...</p>
        </div>
    </div>


    <script>
        // --- CONFIGURACIÓN DE LA API DE GEMINI ---
        const API_KEY = ""; // La clave se proporcionará automáticamente en el entorno de Canvas
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        const TTS_VOICE = "Puck"; // Voz animada y optimista
        const SPLASH_DURATION_MS = 3000; // Duración de la pantalla de precarga: 3 segundos
        // ----------------------------------------

        // LÓGICA DE JAVASCRIPT
        
        // 1. Definición de la Rutina Completa para la semana
        const ROUTINE_DATA = {
            "Lunes": {
                title: "Día de Fuerza y Estabilidad",
                exercises: [
                    { name: "Calentamiento Articular", type: "WORK", duration: 60, icon: '🔥' },
                    { name: "Circuito A (Ronda 1)", type: "WORK", duration: 0 },
                    { name: "Sentadillas con peso corporal", type: "WORK", duration: 45, refId: 'ex1' },
                    { name: "Descanso Breve", type: "REST", duration: 15 },
                    { name: "Flexiones (rodillas o completas)", type: "WORK", duration: 45, refId: 'ex2' },
                    { name: "Descanso Breve", type: "REST", duration: 15 },
                    { name: "Puente de Glúteos (15 reps)", type: "WORK", duration: 45, refId: 'ex3' },
                    { name: "Descanso Largo", type: "REST", duration: 60 },
                    { name: "Circuito B (Ronda 1)", type: "WORK", duration: 0 },
                    { name: "Plancha (Core)", type: "WORK", duration: 45, refId: 'ex4' },
                    { name: "Descanso Breve", type: "REST", duration: 15 },
                    { name: "Superman (Espalda)", type: "WORK", duration: 45, refId: 'ex5' },
                    { name: "Descanso Breve", type: "REST", duration: 15 },
                    { name: "Estocadas (10 por pierna)", type: "WORK", duration: 45, refId: 'ex6' },
                    { name: "Enfriamiento y Estiramiento", type: "REST", duration: 180 },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            },
            "Martes": {
                title: "Día de Cardio y Agilidad (HIIT)",
                exercises: [
                    { name: "Calentamiento Cardiovascular", type: "WORK", duration: 60, refId: 'ex7' },
                    { name: "Burpees modificados", type: "WORK", duration: 60, refId: 'ex8' },
                    { name: "Descanso", type: "REST", duration: 30 },
                    { name: "Mountain Climbers", type: "WORK", duration: 60, refId: 'ex9' },
                    { name: "Descanso", type: "REST", duration: 30 },
                    { name: "Saltos de Tijera (Jumping Jacks)", type: "WORK", duration: 60, refId: 'ex10' },
                    { name: "Descanso Largo", type: "REST", duration: 60 },
                    { name: "High Knees (Rodillas al pecho)", type: "WORK", duration: 60, refId: 'ex11' },
                    { name: "Enfriamiento y Estiramiento", type: "REST", duration: 180 },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            },
            "Miercoles": {
                title: "Día de Descanso Activo y Movilidad",
                exercises: [
                    { name: "Estiramiento Dinámico", type: "WORK", duration: 300, refId: 'ex12' },
                    { name: "Caminata o Yoga Suave", type: "WORK", duration: 1200, refId: 'ex13' },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            },
            "Jueves": {
                title: "Día de Empuje y Tracción",
                exercises: [
                    { name: "Calentamiento de Hombros y Espalda", type: "WORK", duration: 60, refId: 'ex14' },
                    { name: "Remo con toalla (o bandas)", type: "WORK", duration: 45, refId: 'ex15' },
                    { name: "Descanso", type: "REST", duration: 15 },
                    { name: "Elevación de Pantorrillas (20 reps)", type: "WORK", duration: 45, refId: 'ex16' },
                    { name: "Descanso", type: "REST", duration: 15 },
                    { name: "Fondos en silla (Tríceps)", type: "WORK", duration: 45, refId: 'ex17' },
                    { name: "Descanso Largo", type: "REST", duration: 60 },
                    { name: "V-Ups (Abdominales)", type: "WORK", duration: 45, refId: 'ex18' },
                    { name: "Descanso", type: "REST", duration: 15 },
                    { name: "Toques de Hombro en Plancha", type: "WORK", duration: 45, refId: 'ex19' },
                    { name: "Enfriamiento y Estiramiento", type: "REST", duration: 180 },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            },
            "Viernes": {
                title: "Día de Resistencia y Full Body",
                exercises: [
                    { name: "Calentamiento de Movilidad", type: "WORK", duration: 60, refId: 'ex20' },
                    { name: "Circuito Tabata (40s work / 20s rest)", type: "WORK", duration: 0 },
                    { name: "Ronda 1: Sentadillas", type: "WORK", duration: 40, refId: 'ex21' },
                    { name: "Descanso", type: "REST", duration: 20 },
                    { name: "Ronda 2: Flexiones", type: "WORK", duration: 40, refId: 'ex22' },
                    { name: "Descanso", type: "REST", duration: 20 },
                    { name: "Ronda 3: Estocadas", type: "WORK", duration: 40, refId: 'ex23' },
                    { name: "Descanso Largo", type: "REST", duration: 60 },
                    { name: "Ronda 4: Plancha", type: "WORK", duration: 40, refId: 'ex24' },
                    { name: "Descanso", type: "REST", duration: 20 },
                    { name: "Ronda 5: Burpees", type: "WORK", duration: 40, refId: 'ex25' },
                    { name: "Enfriamiento y Estiramiento", type: "REST", duration: 180 },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            },
            "Sabado": {
                title: "Reto de 15 Minutos de Cardio Intenso",
                exercises: [
                    { name: "Calentamiento Rápido", type: "WORK", duration: 60, refId: 'ex26' },
                    { name: "Circuito libre (15 minutos continuos)", type: "WORK", duration: 900, refId: 'ex27' },
                    { name: "Enfriamiento y Estiramiento Profundo", type: "REST", duration: 300, refId: 'ex28' },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            },
            "Domingo": {
                title: "Descanso Completo (Recuperación)",
                exercises: [
                    { name: "Descanso Activo (Opcional: Caminata)", type: "REST", duration: 0 },
                    { name: "Preparación para la Semana (Mental)", type: "REST", duration: 0, refId: 'ex29' },
                    { name: "Rutina Terminada", type: "DONE", duration: 0 }
                ]
            }
        };

        // 2. Variables de Estado Global
        let currentDay = "Lunes";
        let WORKOUT_ROUTINE = ROUTINE_DATA[currentDay].exercises;
        let currentStepIndex = 0;
        let timeLeft = 0;
        let timerInterval;
        let isPaused = false;
        let audioContext; // Contexto de Audio para la alerta sonora

        // 3. Elementos del DOM (Interfaz)
        const htmlElement = document.documentElement;
        const splashScreen = document.getElementById('splash-screen');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const activityDisplay = document.getElementById('current-activity');
        const countdownDisplay = document.getElementById('countdown-display');
        const timerPanel = document.getElementById('timer-panel');
        const statusBar = document.getElementById('status-bar');
        const routineItemsList = document.getElementById('routine-items');
        const dayTabs = document.getElementById('day-tabs');
        const currentDayTitle = document.getElementById('current-day-title');
        const variationModal = document.getElementById('variation-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalContentText = document.getElementById('modal-content-text');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Utilidades para la API de Gemini ---

        /**
         * Realiza la lógica de reintento con retroceso exponencial.
         * @param {Function} fetcher La función que realiza la llamada a la API.
         * @param {number} maxRetries Número máximo de reintentos.
         */
        async function fetchWithRetry(fetcher, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetcher();
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429) { // Límite de tasa
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API returned status ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Llama a la API de Gemini para generar variaciones de ejercicios.
         * @param {string} exerciseName Nombre del ejercicio.
         */
        async function generateVariations(exerciseName) {
            loadingIndicator.classList.remove('hidden');
            modalTitle.textContent = `Variaciones para ${exerciseName}`;
            modalContentText.textContent = '';

            const systemPrompt = `Eres un entrenador de fitness profesional. Proporciona variaciones del ejercicio solicitado para hacerlo más fácil o más difícil. La respuesta debe estar formateada en Markdown con viñetas. NO uses títulos ni encabezados, solo las viñetas.`;
            const userQuery = `Dame 3 variaciones para el ejercicio "${exerciseName}": una para principiantes (más fácil), una avanzada (más difícil) y una enfocada en un grupo muscular diferente si es posible.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const fetcher = () => fetch(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const response = await fetchWithRetry(fetcher);
                const result = await response.json();
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar contenido. Inténtalo de nuevo.";
                
                // Formatear el markdown simple a HTML
                const formattedText = generatedText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negritas
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                modalContentText.innerHTML = formattedText;
                
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                modalContentText.textContent = "Ocurrió un error al cargar las variaciones. Por favor, revisa la consola para más detalles.";
            } finally {
                loadingIndicator.classList.add('hidden');
                variationModal.classList.remove('hidden');
            }
        }

        /**
         * Convierte datos PCM base64 a un Blob WAV.
         */
        function pcmToWav(base64Data, sampleRate) {
            const pcmData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
            
            // Los datos son PCM de 16 bits. Calculamos el tamaño y el número de muestras.
            const numChannels = 1;
            const bitDepth = 16;
            const byteRate = sampleRate * numChannels * (bitDepth / 8);
            const blockAlign = numChannels * (bitDepth / 8);
            const dataSize = pcmData.length;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;

            // RIFF chunk
            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset + i, s.charCodeAt(i));
                }
                offset += s.length;
            }

            // Escribir cabecera WAV
            writeString('RIFF'); // ChunkID
            view.setUint32(offset, 36 + dataSize, true); offset += 4; // ChunkSize
            writeString('WAVE'); // Format
            
            // fmt chunk
            writeString('fmt '); // Subchunk1ID
            view.setUint32(offset, 16, true); offset += 4; // Subchunk1Size (16 para PCM)
            view.setUint16(offset, 1, true); offset += 2; // AudioFormat (1 para PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // NumChannels
            view.setUint32(offset, sampleRate, true); offset += 4; // SampleRate
            view.setUint32(offset, byteRate, true); offset += 4; // ByteRate
            view.setUint16(offset, blockAlign, true); offset += 2; // BlockAlign
            view.setUint16(offset, bitDepth, true); offset += 2; // BitsPerSample
            
            // data chunk
            writeString('data'); // Subchunk2ID
            view.setUint32(offset, dataSize, true); offset += 4; // Subchunk2Size
            
            // Escribir los datos PCM
            for (let i = 0; i < dataSize; i++) {
                view.setUint8(offset + i, pcmData[i]);
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * Llama a la API de Gemini TTS para generar y reproducir un mensaje.
         * @param {string} message El texto a convertir a voz.
         */
        async function playTTS(message) {
            // Reemplaza nombres comunes para TTS más claro
            let ttsMessage = message
                .replace("Circuito A (Ronda 1)", "Circuito A, Ronda uno")
                .replace("Circuito B (Ronda 1)", "Circuito B, Ronda uno")
                .replace("HIIT", "High Intensity Interval Training")
                .replace("V-Ups", "Vee Ups");


            const payload = {
                contents: [{
                    parts: [{ text: ttsMessage }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: TTS_VOICE }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const fetcher = () => fetch(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const response = await fetchWithRetry(fetcher);
                const result = await response.json();
                
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("Sample rate missing in mime type.");
                    
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const wavBlob = pcmToWav(audioData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    console.warn("TTS falló o no se recibieron datos de audio:", result);
                }
            } catch (error) {
                console.error("Error al reproducir TTS:", error);
            }
        }
        
        // 4. Funciones de Utilidad
        
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function getTotalDuration(routine) {
            return routine.reduce((sum, step) => sum + step.duration, 0);
        }

        /**
         * Reproduce una alerta sonora de silbato más notoria (beep)
         */
        function playBeep() {
            try {
                if (!audioContext) {
                    // Inicializa AudioContext en el primer intento
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Configuración del sonido más llamativo
                oscillator.type = 'sawtooth'; // Onda diente de sierra (más rica en armónicos que la cuadrada)
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // Frecuencia alta (880 Hz)
                
                // Control de volumen (Ganancia)
                gainNode.gain.setValueAtTime(0.6, audioContext.currentTime); // Volumen al 60%
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4); // Fade out un poco más lento (400ms)

                // Iniciar y detener
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.4); 
            } catch (e) {
                console.error("Error al reproducir sonido:", e);
                // Esto podría fallar si el navegador requiere interacción previa del usuario
            }
        }


        function resetTimerDisplay(day) {
            clearInterval(timerInterval);
            isPaused = false;
            currentStepIndex = 0;
            timeLeft = 0;
            
            // Recalcula el tiempo total
            const totalTime = getTotalDuration(ROUTINE_DATA[day].exercises);
            countdownDisplay.textContent = formatTime(totalTime);
            activityDisplay.textContent = ROUTINE_DATA[day].title;
            statusBar.textContent = `Día de la semana: ${day} (${ROUTINE_DATA[day].title})`;
            
            // Vuelve al estilo de tarjeta de tema por defecto
            timerPanel.className = 'card-bg rounded-xl p-6 sm:p-8 shadow-xl text-center transition-all duration-500';
            countdownDisplay.classList.remove('text-white');
            countdownDisplay.classList.add('text-emerald-500');

            startBtn.textContent = 'Iniciar Rutina';
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
        }

        // 5. Manejo de la Interfaz (Renderizado y Navegación)

        function renderRoutineList(day) {
            const routine = ROUTINE_DATA[day].exercises;
            routineItemsList.innerHTML = '';
            
            routine.forEach((item, index) => {
                // Solo muestra items con duración > 0 o que sean Circuitos/Descanso
                if (item.duration > 0 || item.type !== 'DONE') {
                    const li = document.createElement('li');
                    
                    // Ajuste de clases: se usa dark:text-gray-100 para el texto general de la lista
                    li.className = 'flex items-center justify-between py-3 sm:py-4 transition-all duration-300 hover:bg-gray-50 dark:hover:bg-gray-600 group';
                    
                    if (item.type === 'REST' && item.duration > 0) {
                        li.className += ' bg-yellow-50/50 dark:bg-yellow-900/30 text-gray-700 dark:text-gray-200 font-medium rounded-md';
                    } else if (item.duration === 0 && item.type === 'WORK') {
                         // Separadores de Circuito: Color llamativo en ambos modos
                        li.className = 'text-sm font-semibold text-blue-600 dark:text-blue-400 pt-4 pb-2';
                        li.innerHTML = `<span>${item.name}</span>`;
                        routineItemsList.appendChild(li);
                        return;
                    }

                    // Contenido del item (Checkbox + Label)
                    let checkboxHTML = '';
                    // Importante: text-default es el color base, el modo oscuro lo sobreescribe a blanco
                    let labelClasses = 'flex-1 ml-4 text-default dark:text-gray-100'; 
                    let durationText = item.duration > 0 ? `(${item.duration} seg)` : '';
                    let actionButtonHTML = '';

                    if (item.refId) {
                        checkboxHTML = `<input type="checkbox" id="${item.refId}" data-index="${index}" class="checkbox-item" />`;
                        
                        // Botón de variación (solo para ejercicios de trabajo con duración)
                        if (item.type === 'WORK' && item.duration > 0) {
                             actionButtonHTML = `
                                <button class="generate-variation-btn text-sm p-1.5 ml-4 bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-200 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" data-exercise="${item.name}">
                                    ✨ Variación
                                </button>
                            `;
                        }
                    } else {
                        // Para items sin ID (Descansos Activos/Término)
                        checkboxHTML = `<div class="w-5 h-5 ml-0.5 text-xs flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-500 text-gray-500 dark:text-gray-200">${item.type === 'REST' ? 'R' : ''}</div>`;
                        // Se ajusta el color para textos informativos/cursivas
                        labelClasses += ' italic text-gray-500 dark:text-gray-400'; 
                        durationText = item.duration > 0 ? `(${formatTime(item.duration)})` : '';
                    }

                    li.innerHTML = `
                        <div class="flex items-center flex-1">
                            ${checkboxHTML}
                            <label for="${item.refId}" class="${labelClasses}">${item.name} <span class="text-xs text-gray-400 dark:text-gray-400">${durationText}</span></label>
                        </div>
                        ${actionButtonHTML}
                    `;
                    routineItemsList.appendChild(li);
                }
            });
            
            // Asigna el evento click a los checkboxes inyectados
            document.querySelectorAll('.checkbox-item').forEach(checkbox => {
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita que el evento click del LI interfiera
                    // Lógica opcional para marcar progreso
                });
            });

            // Asigna el evento click a los nuevos botones de variación
            document.querySelectorAll('.generate-variation-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const exerciseName = e.currentTarget.dataset.exercise;
                    if (exerciseName) {
                        generateVariations(exerciseName);
                    }
                });
            });
        }

        function renderDayTabs() {
            const days = Object.keys(ROUTINE_DATA);
            dayTabs.innerHTML = '';

            days.forEach(day => {
                const button = document.createElement('button');
                button.textContent = day;
                button.dataset.day = day;
                
                let classes = 'py-2 px-4 rounded-lg font-medium transition-colors duration-200 text-sm sm:text-base';

                if (day === currentDay) {
                    classes += ' bg-emerald-500 text-white shadow-md';
                } else {
                    // Colores de texto en modo oscuro mejorados
                    classes += ' text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600';
                }

                button.className = classes;
                
                button.addEventListener('click', () => {
                    switchDay(day);
                });

                dayTabs.appendChild(button);
            });
        }
        
        function switchDay(newDay) {
            if (newDay === currentDay) return;
            
            currentDay = newDay;
            WORKOUT_ROUTINE = ROUTINE_DATA[currentDay].exercises;
            
            // 1. Resetear el estado del temporizador
            resetTimerDisplay(currentDay);
            
            // 2. Renderizar las pestañas y la lista
            renderDayTabs();
            renderRoutineList(currentDay);
            currentDayTitle.textContent = currentDay;
        }

        // 6. Lógica del Temporizador (Core)

        function startTimer() {
            // Se debe inicializar el AudioContext en un evento de usuario (como el click del botón de inicio)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (isPaused) {
                isPaused = false;
            } else {
                clearInterval(timerInterval);
                
                // Mensaje motivacional TTS (solo al iniciar por primera vez)
                if (currentStepIndex === 0) {
                     const motivationMessage = `¡Excelente! Estás comenzando el día ${currentDay} de entrenamiento. ¡Concéntrate y da lo mejor de ti!`;
                     playTTS(motivationMessage);
                }
            }
            
            // Buscar el primer paso que no esté completado/saltado
            while (currentStepIndex < WORKOUT_ROUTINE.length && WORKOUT_ROUTINE[currentStepIndex].duration === 0) {
                 if (WORKOUT_ROUTINE[currentStepIndex].type === 'DONE') {
                    // Si es el paso de 'Terminada', forzamos el fin
                    currentStepIndex = WORKOUT_ROUTINE.length - 1;
                    break;
                }
                currentStepIndex++; // Saltar separadores de circuitos o descansos de 0s
            }
            
            if (currentStepIndex >= WORKOUT_ROUTINE.length) {
                nextStep(); // Llama a la finalización
                return;
            }

            const currentActivity = WORKOUT_ROUTINE[currentStepIndex];
            if (timeLeft === 0) {
                timeLeft = currentActivity.duration;
                
                // --- NUEVA LÓGICA DE TTS AL INICIO DE CADA INTERVALO ---
                let announcement = currentActivity.name;
                if(currentActivity.type === 'WORK') {
                    announcement = `Prepárate para ${currentActivity.name}`;
                } else if (currentActivity.type === 'REST') {
                    announcement = `Descanso. Siguiente, ${WORKOUT_ROUTINE[currentStepIndex + 1]?.name || 'el final'}`;
                }
                playTTS(announcement);
                // --------------------------------------------------------
            }

            // Actualiza la visualización
            activityDisplay.textContent = currentActivity.name;
            countdownDisplay.textContent = formatTime(timeLeft);
            
            // Estilos de la tarjeta
            timerPanel.className = 'rounded-xl p-6 sm:p-8 shadow-xl text-center transition-all duration-500';
            countdownDisplay.classList.remove('text-white', 'text-emerald-500');

            if (currentActivity.type === 'WORK') {
                timerPanel.classList.add('panel-work');
            } else if (currentActivity.type === 'REST') {
                timerPanel.classList.add('panel-rest');
            } else if (currentActivity.type === 'DONE') {
                timerPanel.classList.add('panel-done');
            } else {
                timerPanel.classList.add('card-bg');
            }
            
            // Lógica del temporizador (se ejecuta cada 1 segundo)
            timerInterval = setInterval(() => {
                if (isPaused) return;

                timeLeft--;
                countdownDisplay.textContent = formatTime(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    playBeep(); // <--- ALERTA SONORA MEJORADA AQUÍ
                    
                    // Marcar el checkbox si corresponde a un ejercicio principal
                    if (currentActivity.refId) {
                        const checkbox = document.getElementById(currentActivity.refId);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    }
                    
                    currentStepIndex++; // Pasa al siguiente paso
                    timeLeft = 0;
                    nextStep();
                }
            }, 1000);
        }

        function nextStep() {
            if (currentStepIndex >= WORKOUT_ROUTINE.length) {
                // Rutina terminada
                clearInterval(timerInterval);
                const finalStep = WORKOUT_ROUTINE[WORKOUT_ROUTINE.length - 1];
                activityDisplay.textContent = finalStep.name;
                countdownDisplay.textContent = "00:00";
                
                timerPanel.className = 'rounded-xl p-6 sm:p-8 shadow-xl text-center transition-all duration-500 panel-done'; 
                
                startBtn.style.display = 'block';
                startBtn.textContent = 'Volver a Empezar';
                stopBtn.style.display = 'none';
                
                // Mensaje de finalización TTS
                playTTS("¡Felicidades! Has completado tu rutina del día. ¡Buen trabajo!");
                
                return;
            }
            startTimer();
        }

        // 7. Lógica de Tema (Modo Oscuro/Claro)
        function updateThemeIcon(isDark) {
            if (isDark) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            const isDark = htmlElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        themeToggleBtn.addEventListener('click', toggleTheme);
        closeModalBtn.addEventListener('click', () => {
            variationModal.classList.add('hidden');
        });
        variationModal.addEventListener('click', (e) => {
            if (e.target === variationModal) {
                variationModal.classList.add('hidden');
            }
        });


        // 8. Event Listeners y Inicialización
        
        startBtn.addEventListener('click', () => {
            // Se debe inicializar el AudioContext en un evento de usuario (como el click del botón de inicio)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (currentDay === "") {
                activityDisplay.textContent = "Por favor, selecciona un día primero.";
                return;
            }
            
            // Maneja el reinicio
            if (startBtn.textContent.includes('Volver a Empezar')) {
                switchDay(currentDay); // Resetear completamente el día actual
                // No retornar, dejar que inicie abajo
            }
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            startTimer();
        });

        stopBtn.addEventListener('click', () => {
            isPaused = true;
            clearInterval(timerInterval);
            activityDisplay.textContent = "PAUSA - Listo para Reanudar";
            
            timerPanel.classList.remove('panel-work', 'panel-rest', 'panel-done');
            timerPanel.classList.add('bg-gray-300', 'dark:bg-gray-600');
            countdownDisplay.classList.remove('text-white', 'text-emerald-500');
            countdownDisplay.classList.add('text-gray-800', 'dark:text-gray-100');

            startBtn.textContent = 'Reanudar';
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
        });

        // Función para ocultar el Splash Screen
        function hideSplashScreen() {
             // Retraso para que el usuario pueda ver el splash screen
            setTimeout(() => {
                splashScreen.classList.add('hidden');
            }, SPLASH_DURATION_MS); // Usa la constante de 3000ms
        }


        window.onload = function() {
            // 1. Ocultar Splash Screen
            hideSplashScreen(); 
            
            // 2. Cargar Tema (Modo Oscuro/Claro)
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                htmlElement.classList.add('dark');
                updateThemeIcon(true);
            } else {
                htmlElement.classList.remove('dark');
                updateThemeIcon(false);
            }

            // 3. Inicializar Rutina
            const today = new Date().toLocaleDateString('es-ES', { weekday: 'long' });
            // Manejo de nombres de días de la semana en español
            let initialDay = "Lunes";
            if (today.includes('martes')) initialDay = "Martes";
            else if (today.includes('miércoles')) initialDay = "Miercoles";
            else if (today.includes('jueves')) initialDay = "Jueves";
            else if (today.includes('viernes')) initialDay = "Viernes";
            else if (today.includes('sábado')) initialDay = "Sabado";
            else if (today.includes('domingo')) initialDay = "Domingo";
            
            currentDay = initialDay;
            currentDayTitle.textContent = currentDay;
            WORKOUT_ROUTINE = ROUTINE_DATA[currentDay].exercises;

            renderDayTabs();
            renderRoutineList(currentDay);
            resetTimerDisplay(currentDay);
        };
    </script>
</body>
</html>
